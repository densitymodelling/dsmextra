<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Quantify the percentage of data nearby — compute_nearby • dsmextra</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Quantify the percentage of data nearby — compute_nearby" />
<meta property="og:description" content="Calculates the proportion of sample (reference) points lying in the vicinity of prediction (target) points in multivariate environmental space. See the 'Details' section and King &amp;amp; Zeng (2007) for a technical explanation." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dsmextra</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/dsmextra.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/dsmextra-bigdata.html">Using dsmextra with 'big data': An example, with a note on covariate transformations</a>
    </li>
    <li>
      <a href="../articles/dsmextra-covariateselection.html">A priori covariate selection using dsmextra</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Quantify the percentage of data nearby</h1>
    
    <div class="hidden name"><code>compute_nearby.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Calculates the proportion of sample (reference) points lying in the vicinity of prediction (target) points in multivariate environmental space. See the 'Details' section and King &amp; Zeng (2007) for a technical explanation.</p>
    </div>

    <pre class="usage"><span class='fu'>compute_nearby</span>(
  <span class='no'>samples</span>,
  <span class='no'>covariate.names</span>,
  <span class='no'>prediction.grid</span>,
  <span class='no'>coordinate.system</span>,
  <span class='no'>nearby</span>,
  <span class='kw'>max.size</span> <span class='kw'>=</span> <span class='fl'>1e+07</span>,
  <span class='kw'>no.partitions</span> <span class='kw'>=</span> <span class='fl'>10</span>,
  <span class='kw'>resolution</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>verbose</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>
)</pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>samples</th>
      <td><p>Sample (reference) dataset used for model building and calibration. This corresponds to the <code>segment.data</code> used when building density surface models in <code>dsm</code>. It must contain one column for each of the covariates in <code>covariate.names</code>.</p></td>
    </tr>
    <tr>
      <th>covariate.names</th>
      <td><p>Character string. Names of the covariates of interest.</p></td>
    </tr>
    <tr>
      <th>prediction.grid</th>
      <td><p>Prediction data.frame. This contains both geographic coordinates (<code>x</code>, <code>y</code>) and covariate values associated with the target locations for which predictions are desired. Typically, these locations are taken as the centroids of the grid cells in a spatial prediction grid/raster. See <code><a href='https://rdrr.io/pkg/dsm/man/predict.dsm.html'>predict.dsm</a></code>.</p></td>
    </tr>
    <tr>
      <th>coordinate.system</th>
      <td><p>Projected coordinate system relevant to the study location. Can be either a character string or an object of class <code><a href='https://rdrr.io/pkg/sp/man/CRS-class.html'>CRS</a></code>.</p></td>
    </tr>
    <tr>
      <th>nearby</th>
      <td><p>Scalar indicating which reference data points are considered to be 'nearby' (i.e. within ‘nearby’ mean geometric Gower's distances of) prediction points. Defaults to 1, as per Mannocci et al. (2018) and Virgili et al. (2017).</p></td>
    </tr>
    <tr>
      <th>max.size</th>
      <td><p>Minimum size threshold for partitioning computations. Calculated as <code><a href='https://rdrr.io/r/base/prod.html'>prod</a>(<a href='https://rdrr.io/r/base/nrow.html'>nrow</a>(samples),<a href='https://rdrr.io/r/base/nrow.html'>nrow</a>(prediction.grid))</code>. Has a default value of <code>1e7</code>. See the 'Details' section.</p></td>
    </tr>
    <tr>
      <th>no.partitions</th>
      <td><p>Integer. Number of desired partitions of the data (default of 10). See the 'Details' section.</p></td>
    </tr>
    <tr>
      <th>resolution</th>
      <td><p>Resolution of the output raster (in units relevant to <code>coordinate.system</code>). Only required if <code>prediction.grid</code> is irregular, and thus needs to be rasterised. Defaults to NULL.</p></td>
    </tr>
    <tr>
      <th>verbose</th>
      <td><p>Logical. Show or hide possible warnings and messages.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A raster object mapping the proportion of reference data nearby each point in <code>prediction.grid</code>.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>While extrapolation is often seen as a binary concept (i.e. it either does or does not take place), it is reasonable to expect that predictions made at target points situated just outside the sampled environmental space may be more reliable than those made at points far outside it. The ExDet tool available through <code><a href='compute_extrapolation.html'>compute_extrapolation</a></code> inherently quantifies this notion of <em>distance</em> from the envelope of the reference data.</p>
<p>However, the multivariate distribution of reference data points is often far from homogeneous. It is possible, therefore, for target points representing analogue conditions to fall within sparsely sampled regions of the reference space; or conversely, for two target points reflecting an equal degree of extrapolation to have very different amounts of reference data within their vicinity.</p>
<p>The notion of neighbourhood (or percentage/proportion of data nearby, %N) captures this idea, and provides an additional measure of the reliability of extrapolations in multivariate environmental space (Virgili et al. 2017; Mannocci et al. 2018). In practice, %N for any target point can be defined as the proportion of reference data within a radius of one geometric mean Gower’s distance (G^2), calculated between all pairs of reference points (King and Zeng 2007). The Gower’s distance between two points <em>i</em> and <em>j</em> defined along the axes of <em>K</em> covariates is calculated as the average absolute distance between the values of these two points in each dimension, divided by the range of the data, such that:</p>
<p>\(G_{ij}^2=\frac{1}{K}\sum_{k=1}^{K}\frac{\left|x_{ik}-x_{jk}\right|}{\textrm{max}(X_k)-\textrm{min}(X_k)}\)</p>
<p>The <code>compute_nearby</code> function is adapted from the code given in Mannocci et al. (2018) and allows the calculation of Gower’s distances as a basis for defining the neighbourhood.</p>
<p>In addition, the <code>whatif</code> function from the <a href='https://CRAN.R-project.org/package=WhatIf'>Whatif</a> package (Gandrud et al. 2017), which <code>compute_nearby</code> calls internally, may not run on very large datasets. Running calculations on partitions of the data may circumvent this problem and lead to speed gains. Two arguments can be used to do this:</p><table class='table'>
<tr><td><code>max.size</code></td><td>Threshold above which partitioning will be triggered</td></tr>
<tr><td><code>no.partitions</code></td><td>Number of required partitions</td></tr>
</table>
<p>In practice, a run of <code>compute_nearby</code> begins with a quick assessment of the dimensions of the input data, i.e. the reference and target data.frames. If the product of their dimensions (i.e. number of samples multiplied by number of prediction grid cells) exceeds the value set for <code>max.size</code>, then <code>no.partitions</code> subsets of the data will be created and the computations run on each using <code><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></code> functions from the <a href='https://cran.r-project.org/web/packages/purrr/index.html'>purrr</a> package (Henry and Wickham 2019). This means that a smaller <code>max.size</code> will trigger partitioning on correspondingly smaller datasets. By default, <code>max.size</code> is set to <code>1e7</code>. This value was chosen arbitrarily, and should be sufficiently large as to obviate the need for partitioning on most datasets.</p>
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Bouchet PJ, Miller DL, Roberts JJ, Mannocci L, Harris CM and Thomas L (2019). From here and now to there and then: Practical recommendations for extrapolating cetacean density surface models to novel conditions. CREEM Technical Report 2019-01, 59 p. <a href='https://research-repository.st-andrews.ac.uk/handle/10023/18509'>https://research-repository.st-andrews.ac.uk/handle/10023/18509</a></p>
<p>Gandrud C, King G, Stoll H, Zeng L (2017). WhatIf: Evaluate Counterfactuals. R package version 1.5-9. <a href='https://CRAN.R-project.org/package=WhatIf'>https://CRAN.R-project.org/package=WhatIf</a>.</p>
<p>Henry L, Wickham H (2019). purrr: Functional Programming Tools. R package version 0.3.2. <a href='https://CRAN.R-project.org/package=purrr'>https://CRAN.R-project.org/package=purrr</a>.</p>
<p>King G, Zeng L (2007). When can history be our guide? The pitfalls of counterfactual inference. International Studies Quarterly 51, 183–210. DOI: <a href='https://www.jstor.org/stable/pdf/4621707.pdf?seq=1#page_scan_tab_contents'>10.1111/j.1468-2478.2007.00445.x</a></p>
<p>Mannocci L, Roberts JJ, Halpin PN, Authier M, Boisseau O, Bradai MN, Canãdas A, Chicote C, David L, Di-Méglio N, Fortuna CM, Frantzis A, Gazo M, Genov T, Hammond PS, Holcer D, Kaschner K, Kerem D, Lauriano G, Lewis T, Notarbartolo Di Sciara G, Panigada S, Raga JA, Scheinin A, Ridoux V, Vella A, Vella J (2018). Assessing cetacean surveys throughout the mediterranean sea: A gap analysis in environmental space. Scientific Reports 8, art3126. DOI: <a href='https://www.nature.com/articles/s41598-018-19842-9'>10.5061/dryad.4pd33</a>.</p>
<p>Virgili A, Racine M, Authier M, Monestiez P, Ridoux V (2017). Comparison of habitat models for scarcely detected species. Ecological Modelling 346, 88–98. DOI: <a href='https://www.sciencedirect.com/science/article/pii/S0304380016308146'>10.1016/j.ecolmodel.2016.12.013</a>.</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='fu'><a href='https://rdrr.io/r/base/library.html'>library</a></span>(<span class='no'>dsmextra</span>)

<span class='co'># Load the Mid-Atlantic sperm whale data (see ?spermwhales)</span>
<span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span>(<span class='no'>spermwhales</span>)

<span class='co'># Extract the data</span>
<span class='no'>segs</span> <span class='kw'>&lt;-</span> <span class='no'>spermwhales</span>$<span class='no'>segs</span>
<span class='no'>predgrid</span> <span class='kw'>&lt;-</span> <span class='no'>spermwhales</span>$<span class='no'>predgrid</span>

<span class='co'># Define relevant coordinate system</span>
<span class='no'>my_crs</span> <span class='kw'>&lt;-</span> <span class='kw pkg'>sp</span><span class='kw ns'>::</span><span class='fu'><a href='https://rdrr.io/pkg/sp/man/CRS-class.html'>CRS</a></span>(<span class='st'>"+proj=aea +lat_1=38 +lat_2=30 +lat_0=34 +lon_0=-73 +x_0=0
 +y_0=0 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0"</span>)

<span class='co'># Assess the percentage of data nearby</span>
<span class='no'>spermw.nearby</span> <span class='kw'>&lt;-</span> <span class='fu'>compute_nearby</span>(<span class='kw'>samples</span> <span class='kw'>=</span> <span class='no'>segs</span>,
                               <span class='kw'>prediction.grid</span> <span class='kw'>=</span> <span class='no'>predgrid</span>,
                               <span class='kw'>coordinate.system</span> <span class='kw'>=</span> <span class='no'>my_crs</span>,
                               <span class='kw'>covariate.names</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"Depth"</span>, <span class='st'>"DistToCAS"</span>, <span class='st'>"SST"</span>, <span class='st'>"EKE"</span>, <span class='st'>"NPP"</span>),
                               <span class='kw'>nearby</span> <span class='kw'>=</span> <span class='fl'>1</span>)</div><div class='output co'>#&gt; <span class='message'>Preprocessing data ...</span></div><div class='output co'>#&gt; <span class='message'>Calculating distances ....</span></div><div class='output co'>#&gt; <span class='message'>Calculating the geometric variance...</span></div><div class='output co'>#&gt; <span class='message'>Calculating cumulative frequencies ...</span></div><div class='output co'>#&gt; <span class='message'>Finishing up ...</span></div><div class='output co'>#&gt; <span class='message'>Done!</span></div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Phil Bouchet, David Miller, Laura Mannocci, Jason Roberts, Catriona Harris, Len Thomas.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


